<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Financial Reports</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="/css/styles.css?v=1" />

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background: #f5f7fa;
      color: #2c3e50;
    }
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      background: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background: #34495e;
      color: #fff;
    }
    .summary {
      background: #fff;
      padding: 20px;
      border: 1px solid #ddd;
      width: 60%;
      margin-bottom: 30px;
    }
    .positive { color: green; font-weight: bold; }
    .negative { color: red; font-weight: bold; }
    .unreviewed { background: #fff3cd; }
    .locked { background:#f8d7da; padding:10px; margin-bottom:15px; }
    #chartToggle button { margin-right: 10px; }
  </style>
</head>

<body>

<script src="js/auth.js"></script>
<script>requireAuth();</script>

<nav>
  <strong>Small Business Financials</strong>
  <div>
    <a href="dashboard.html">Dashboard</a> |
    <a href="financialreports.html">Financial Reports</a> |
    <a href="#" onclick="logoutUser()">Logout</a>
  </div>
</nav>

<header>
  <h1>Financial Reports</h1>
  <p>Bookkeeping by period with review, locking, and financial intelligence.</p>
</header>

<!-- =====================
     UPGRADE BANNER
     ===================== -->
<div id="upgradeBanner" class="locked" style="display:none;">
  <strong>Upgrade to Pro</strong><br>
  Unlock period closing, financial insights, comparisons, and imports.<br><br>
  <button id="upgradeBtn">Upgrade to Pro</button>
</div>

<label><strong>Period:</strong></label>
<select id="periodSelector">
  <option value="2026-01">January 2026</option>
  <option value="2026-02">February 2026</option>
</select>

<button id="closePeriodBtn">Close Period</button>
<button id="reopenPeriodBtn" style="display:none;">Reopen Period</button>

<div id="lockNotice" class="locked" style="display:none;">
  ðŸ”’ This period is closed. Transactions are locked.
</div>

<hr>

<h2>Manual Transaction Entry</h2>
<div>
  <input type="date" id="mDate">
  <input type="text" id="mDesc" placeholder="Description">
  <input type="number" id="mAmt" step="0.01" placeholder="Amount">
  <select id="mType">
    <option value="expense">Expense</option>
    <option value="income">Income</option>
  </select>
  <input type="text" id="mCat" placeholder="Category">
  <button id="addTxnBtn">Add</button>
</div>

<hr>

<input type="file" id="fileInput" accept=".csv,.xlsx" />

<h2>Expense Transactions</h2>
<table id="debitTable">
  <thead>
    <tr>
      <th>Date</th><th>Description</th><th>Category</th>
      <th>Amount</th><th>Reviewed</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Income Transactions</h2>
<table id="creditTable">
  <thead>
    <tr>
      <th>Date</th><th>Description</th><th>Category</th>
      <th>Amount</th><th>Reviewed</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Financial Summary (Reviewed Only)</h2>
<div class="summary">
  <p>Total Expenses: $<span id="totalDebits">0.00</span></p>
  <p>Total Income: $<span id="totalCredits">0.00</span></p>
  <p>Net Profit: $<span id="netBalance">0.00</span></p>
</div>

<h2>Financial Health Insights</h2>
<div id="insightsPanel" class="summary"></div>

<h2>Period Comparison</h2>
<div id="trendPanel" class="summary"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* =====================
     PLAN STORAGE (LOCAL)
     ===================== */
  function getPlan() {
    const user = getCurrentUser();
    return user?.plan || localStorage.getItem("sbfa_plan") || "free";
  }

  function setPlan(plan) {
    localStorage.setItem("sbfa_plan", plan);
    const user = getCurrentUser();
    if (user) user.plan = plan;
  }

  function requirePro(feature) {
    if (getPlan() !== "pro") {
      alert(feature + " is available on the Pro plan.");
      return false;
    }
    return true;
  }

  /* =====================
     UPGRADE CTA
     ===================== */
  const upgradeBanner = document.getElementById("upgradeBanner");
  const upgradeBtn = document.getElementById("upgradeBtn");

  if (getPlan() !== "pro") {
    upgradeBanner.style.display = "block";
  }

  upgradeBtn.onclick = () => {
    const ok = confirm(
      "This will upgrade your account to Pro.\n\n" +
      "Use this after receiving payment via Cash App, Zelle, or invoice.\n\n" +
      "Continue?"
    );
    if (!ok) return;

    setPlan("pro");
    upgradeBanner.style.display = "none";
    alert("ðŸŽ‰ Pro features unlocked.");
  };

  /* =====================
     PERIOD LOGIC
     ===================== */
  let currentPeriod = periodSelector.value;

  function periodKey(p) {
    return `sbfa_period_${getCurrentUser().email}_${p}`;
  }

  function txnKey(p) {
    return `sbfa_txns_${getCurrentUser().email}_${p}`;
  }

  function isClosed(p=currentPeriod) {
    return JSON.parse(localStorage.getItem(periodKey(p)) || "{}").closed;
  }

  function loadTxns(p=currentPeriod) {
    return JSON.parse(localStorage.getItem(txnKey(p)) || "[]")
      .filter(t => t.reviewed);
  }

  function summarize(txns) {
    let income=0, expenses=0;
    txns.forEach(t=>{
      if(t.type==="income") income+=t.amount;
      else expenses+=t.amount;
    });
    return { income, expenses, net: income-expenses };
  }

  function previousPeriod(p) {
    const [y,m]=p.split("-").map(Number);
    return m===1 ? `${y-1}-12` : `${y}-${String(m-1).padStart(2,"0")}`;
  }

  function generateTrends() {
    if (!requirePro("Period comparison")) {
      trendPanel.innerHTML =
        "<em>Upgrade to Pro to unlock period comparisons.</em>";
      return;
    }

    const prev = previousPeriod(currentPeriod);

    if (!isClosed(currentPeriod) || !isClosed(prev)) {
      trendPanel.innerHTML =
        "<em>Close both periods to view comparisons.</em>";
      return;
    }

    const curr = summarize(loadTxns(currentPeriod));
    const prior = summarize(loadTxns(prev));

    function diff(a,b){ return ((a-b)/Math.max(b,1)*100).toFixed(1); }

    trendPanel.innerHTML = `
      <ul>
        <li><strong>Income:</strong> ${diff(curr.income, prior.income)}%</li>
        <li><strong>Expenses:</strong> ${diff(curr.expenses, prior.expenses)}%</li>
        <li><strong>Net:</strong> ${curr.net >= prior.net ? "Improved" : "Declined"}</li>
      </ul>
    `;
  }

  function generateInsights() {
    if (!requirePro("Financial insights")) {
      insightsPanel.innerHTML =
        "<em>Upgrade to Pro to unlock financial insights.</em>";
      return;
    }

    if (!isClosed()) {
      insightsPanel.innerHTML =
        "<em>Close the period to view insights.</em>";
      return;
    }

    const {income,expenses,net} = summarize(loadTxns());

    insightsPanel.innerHTML = `
      <ul>
        <li><strong>Net Result:</strong> $${net.toFixed(2)}</li>
        <li><strong>Expense Ratio:</strong>
          ${(income?expenses/income*100:0).toFixed(1)}%</li>
        <li><strong>Status:</strong>
          ${net>=0?"Healthy":"Needs attention"}</li>
      </ul>
    `;
  }

  closePeriodBtn.onclick = () => {
    if (!requirePro("Period closing")) return;
    localStorage.setItem(
      periodKey(currentPeriod),
      JSON.stringify({closed:true,closedAt:new Date().toISOString()})
    );
    generateInsights();
    generateTrends();
  };

  reopenPeriodBtn.onclick = () => {
    localStorage.setItem(
      periodKey(currentPeriod),
      JSON.stringify({closed:false})
    );
    insightsPanel.innerHTML = "";
    trendPanel.innerHTML = "";
  };

  periodSelector.onchange = e => {
    currentPeriod = e.target.value;
    generateInsights();
    generateTrends();
  };

  fileInput.onchange = () => {
    if (!requirePro("File imports")) return;
  };

  generateInsights();
  generateTrends();

});
</script>

</body>
</html>
